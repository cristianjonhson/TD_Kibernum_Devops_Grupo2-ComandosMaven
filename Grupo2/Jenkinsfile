pipeline {
  agent any

  environment {
    MAVEN_HOME = tool 'Maven 3' // Define tu herramienta Maven configurada en Jenkins
    JAVA_HOME = tool 'jdk 17' // Define tu herramienta JDK configurada en Jenkins
    PATH = "${MAVEN_HOME}/bin:${JAVA_HOME}/bin:${env.PATH}"
  }

  stages {
    /*stage('Checkout') {
      steps {
        // Clonar el repositorio
        git url: 'https://github.com/cristianjonhson/TD_Kibernum_Devops_Grupo2-ComandosMaven.git', branch: 'master'
      }
    }*/

    stage('Build') {
      steps {
        // Construir el proyecto con Maven
        sh 'mvn -f Grupo2/pom.xml clean install'
      }
    }

    /*stage('Test') {
      steps {
        // Ejecutar pruebas con Maven
        sh 'mvn -f Grupo2/pom.xml test'
      }
      post {
        always {
          // Publicar resultados de pruebas
          junit '**/ /*target/surefire-reports/*.xml'
        }
      }
    }*/

    stage('Upload Artifact') {
      steps {
        script {
          // Read POM xml file using 'readMavenPom' step , this step 'readMavenPom' is included in: https://plugins.jenkins.io/pipeline-utility-steps
          pom = readMavenPom file: "Grupo2/pom.xml";
          // Find built artifact under target folder
          filesByGlob = findFiles(glob: "target/*.${pom.packaging}");
          // Print some info from the artifact found
          echo "${filesByGlob[0].name} ${filesByGlob[0].path} ${filesByGlob[0].directory} ${filesByGlob[0].length} ${filesByGlob[0].lastModified}"
          // Extract the path from the File found
          artifactPath = filesByGlob[0].path;
          // Assign to a boolean response verifying If the artifact name exists
          artifactExists = fileExists artifactPath;

          if(artifactExists) {
            echo "*** File: ${artifactPath}, group: ${pom.groupId}, packaging: ${pom.packaging}, version ${pom.version}";

            nexusArtifactUploader(
              nexusVersion: 'nexus3',
              protocol: 'http',
              nexusUrl: 'localhost:8081',
              groupId: 'cl.TalentoDigitalKibernum',
              version: "1.0.1",
              repository: 'comandosmaven',
              credentialsId: 'NexusLogin',
              artifacts: [
                [artifactId: 'Grupo2',
                classifier: '',
                file: 'Grupo2/target/Grupo2-1.0-SNAPSHOT.jar',
                type: 'jar']
              ]
            );
          }
          else {
              error "*** File: ${artifactPath}, could not be found";
          }
        }
      }
    }
  }
    
  /*post {
      always {
        // Limpieza de archivos temporales
        cleanWs()
      
    }
  }*/
}